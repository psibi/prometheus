<!doctype html>
<html lang="en">
<head>
<title></title>
<!-- 2022-01-03 Mon 13:00 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Sibi Prabakaran">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Scaling and Reliability</a></li>
<li><a href="#sec-2">2. Reliablity and fault tolerance</a>
<ul class="nav">
<li><a href="#sec-2-1">2.1. Setting up Alertmanager clustering</a></li>
<li><a href="#sec-2-2">2.2. Configuring Prometheus for an Alertmanager cluster</a></li>
</ul>
</li>
<li><a href="#sec-3">3. Scaling</a>
<ul class="nav">
<li><a href="#sec-3-1">3.1. Functional scaling</a></li>
<li><a href="#sec-3-2">3.2. Horizontal shards</a></li>
</ul>
</li>
<li><a href="#sec-4">4. Remote storage</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title"></h1>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Scaling and Reliability</h2>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> Reliablity and fault tolerance</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Fault tolreance for monitoring services is addressed by making the
monitoring service highly availably usually by clustering the
implementation. Clustering solution however require complex
networking and management of state between nodes in the cluster.
</li>
<li>The recommended fault toloreant solution for Prometheus is to run
two identically configured Prometheus servers in parallel, both
active at the same time. Duplicate alerts are handled upstream in
Alertmanager using it's grouping and inhibits capacity.
</li>
<li>Alertmanager is made fault tolerant by creating a cluster of
Alertmanagers. All prometheus servers send alerts to all
Alertmanagers.


<figure>
<p><img src="assets/fault-tolerance-arch.png" class="img-responsive" alt="fault-tolerance-arch.png">
</p>
</figure>
</li>
</ul>
</div>

<div id="outline-container-sec-2-1" class="outline-3">
<h3 id="sec-2-1"><span class="section-number-3">2.1</span> Setting up Alertmanager clustering</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Cluster capability provided by Hashicorp's memberlist library which
uses a gossip based protocol.
</li>
</ul>

<p>
Let's say we have three hosts <code>am1</code>, <code>am2</code> and <code>am3</code>. We will use the
<code>am1</code> host to initiate the cluster.
</p>

<div class="highlight"><pre><span></span>am1$ alertmanager --config.file alertmanager.yml --cluster.listen-address 172.19.0.10:8001
am2$ alertmanager --config.file alertmanager.yml --cluster.listen-address 172.19.0.20:8001 --cluster.peer 172.19.0.10:8001
am3$ alertmanager --config.file alertmanager.yml --cluster.listen-address 172.19.0.30:8001 --cluster.peer 172.19.0.10:8001
</pre></div>

<p>
You can check that they are indeed clustered at <a href="https://127.0.0.1:9000/status">https://127.0.0.1:9000/status</a>
</p>
</div>
</div>

<div id="outline-container-sec-2-2" class="outline-3">
<h3 id="sec-2-2"><span class="section-number-3">2.2</span> Configuring Prometheus for an Alertmanager cluster</h3>
<div class="outline-text-3" id="text-2-2">
<p>
Edit prometheus.yml:
</p>

<div class="highlight"><pre><span></span>alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - am1:9093
      - am2:9093
      - am3:9093
</pre></div>

<p>
The above configuration assumes that the Prometheus server can
resolve DNS entries for each of the alertmanager.
</p>
</div>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Scaling</h2>
<div class="outline-text-2" id="text-3">
<p>
Scaling usually takes two forms:
</p>
<ul class="org-ul">
<li>Functional scaling
</li>
<li>Horizontal scaling
</li>
</ul>
</div>

<div id="outline-container-sec-3-1" class="outline-3">
<h3 id="sec-3-1"><span class="section-number-3">3.1</span> Functional scaling</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Splits monitoring concerns onto separate Prometheus servers.


<figure>
<p><img src="assets/functional-sharding.png" class="img-responsive" alt="functional-sharding.png">
</p>
</figure>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-3-2" class="outline-3">
<h3 id="sec-3-2"><span class="section-number-3">3.2</span> Horizontal shards</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Horizontal sharding uses a series of worker prometheus servers each
of which scrapes a subset of targets. We then aggregate specific
time series we're interested in on the worker servers.
</li>
<li>The proimary server not only pulls in the aggregated metrics but now
also acts as the default source for graphing or exposing metrics to
tools like Grafana.


<figure>
<p><img src="assets/horizontal-sharding.png" class="img-responsive" alt="horizontal-sharding.png">
</p>
</figure>
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Remote storage</h2>
<div class="outline-text-2" id="text-4">
<p>
Prometheus has the capability to write to remote stores of metrics.
</p>
</div>
</div>
</div></div></div>
<footer id="postamble" class="">
<div><p class="author">Author: Sibi Prabakaran</p>
<p class="date">Created: 2022-01-03 Mon 13:00</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="http://orgmode.org">Org-mode</a> 9.4.4)</p>
</div>
</footer>
</body>
</html>
