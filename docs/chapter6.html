<!doctype html>
<html lang="en">
<head>
<title></title>
<!-- 2022-01-03 Mon 13:05 -->
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="generator" content="Org-mode">
<meta name="author" content="Sibi Prabakaran">

<link  href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.5/js/bootstrap.min.js"></script>
<style>
/* org mode styles on top of twbs */

html {
    position: relative;
    min-height: 100%;
}

body {
    font-size: 18px;
    margin-bottom: 105px;
}

footer {
    position: absolute;
    bottom: 0;
    width: 100%;
    height: 101px;
    background-color: #f5f5f5;
}

footer > div {
    padding: 10px;
}

footer p {
    margin: 0 0 5px;
    text-align: center;
    font-size: 16px;
}

#table-of-contents {
    margin-top: 20px;
    margin-bottom: 20px;
}

blockquote p {
    font-size: 18px;
}

pre {
    font-size: 16px;
}

.footpara {
    display: inline-block;
}

figcaption {
  font-size: 16px;
  color: #666;
  font-style: italic;
  padding-bottom: 15px;
}

/* from twbs docs */

.bs-docs-sidebar.affix {
    position: static;
}
@media (min-width: 768px) {
    .bs-docs-sidebar {
        padding-left: 20px;
    }
}

/* All levels of nav */
.bs-docs-sidebar .nav > li > a {
    display: block;
    padding: 4px 20px;
    font-size: 14px;
    font-weight: 500;
    color: #999;
}
.bs-docs-sidebar .nav > li > a:hover,
.bs-docs-sidebar .nav > li > a:focus {
    padding-left: 19px;
    color: #A1283B;
    text-decoration: none;
    background-color: transparent;
    border-left: 1px solid #A1283B;
}
.bs-docs-sidebar .nav > .active > a,
.bs-docs-sidebar .nav > .active:hover > a,
.bs-docs-sidebar .nav > .active:focus > a {
    padding-left: 18px;
    font-weight: bold;
    color: #A1283B;
    background-color: transparent;
    border-left: 2px solid #A1283B;
}

/* Nav: second level (shown on .active) */
.bs-docs-sidebar .nav .nav {
    display: none; /* Hide by default, but at >768px, show it */
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 30px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav > li > a:focus {
    padding-left: 29px;
}
.bs-docs-sidebar .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav > .active:focus > a {
    padding-left: 28px;
    font-weight: 500;
}

/* Nav: third level (shown on .active) */
.bs-docs-sidebar .nav .nav .nav {
    padding-bottom: 10px;
}
.bs-docs-sidebar .nav .nav .nav > li > a {
    padding-top: 1px;
    padding-bottom: 1px;
    padding-left: 40px;
    font-size: 12px;
    font-weight: normal;
}
.bs-docs-sidebar .nav .nav .nav > li > a:hover,
.bs-docs-sidebar .nav .nav .nav > li > a:focus {
    padding-left: 39px;
}
.bs-docs-sidebar .nav .nav .nav > .active > a,
.bs-docs-sidebar .nav .nav .nav > .active:hover > a,
.bs-docs-sidebar .nav .nav .nav > .active:focus > a {
    padding-left: 38px;
    font-weight: 500;
}

/* Show and affix the side nav when space allows it */
@media (min-width: 992px) {
    .bs-docs-sidebar .nav > .active > ul {
        display: block;
    }
    /* Widen the fixed sidebar */
    .bs-docs-sidebar.affix,
    .bs-docs-sidebar.affix-bottom {
        width: 213px;
    }
    .bs-docs-sidebar.affix {
        position: fixed; /* Undo the static from mobile first approach */
        top: 20px;
    }
    .bs-docs-sidebar.affix-bottom {
        position: absolute; /* Undo the static from mobile first approach */
    }
    .bs-docs-sidebar.affix .bs-docs-sidenav,.bs-docs-sidebar.affix-bottom .bs-docs-sidenav {
        margin-top: 0;
        margin-bottom: 0
    }
}
@media (min-width: 1200px) {
    /* Widen the fixed sidebar again */
    .bs-docs-sidebar.affix-bottom,
    .bs-docs-sidebar.affix {
        width: 263px;
    }
}
</style>
<script>
$(function() {
    'use strict';

    $('.bs-docs-sidebar li').first().addClass('active');

    $(document.body).scrollspy({target: '.bs-docs-sidebar'});

    $('.bs-docs-sidebar').affix();
});
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="https://psibi.in/prometheus/"> UP </a>
 |
 <a accesskey="H" href="https://psibi.in/"> HOME </a>
</div><div id="content" class="container">
<div class="row"><div class="col-md-3 col-md-push-9"><nav id="table-of-contents">
<div id="text-table-of-contents" class="bs-docs-sidebar">
<ul class="nav">
<li><a href="#sec-1">1. Alerting and Alertmanager</a></li>
<li><a href="#sec-2">2. How the Alertmanager works</a></li>
<li><a href="#sec-3">3. Installing Alertmanager</a></li>
<li><a href="#sec-4">4. Configuring the Alertmanager</a></li>
<li><a href="#sec-5">5. Running Alertmanger</a>
<ul class="nav">
<li><a href="#sec-5-1">5.1. Configuring prometheus for Alertmanager</a></li>
<li><a href="#sec-5-2">5.2. Monitoring Alertmanager</a></li>
</ul>
</li>
<li><a href="#sec-6">6. Adding alerting rules</a></li>
<li><a href="#sec-7">7. Alert States</a></li>
<li><a href="#sec-8">8. Routing</a>
<ul class="nav">
<li><a href="#sec-8-1">8.1. Resolution alerts</a></li>
</ul>
</li>
<li><a href="#sec-9">9. Silences and maintenance</a></li>
<li><a href="#sec-10">10. References</a></li>
</ul>
</div>
</nav>
</div><div class="col-md-9 col-md-pull-3"><h1 class="title"></h1>
<div id="outline-container-sec-1" class="outline-2">
<h2 id="sec-1"><span class="section-number-2">1</span> Alerting and Alertmanager</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Alerting is providded by a tool called Alertmanager.
</li>
<li>Alerting rules are defined on your prometheus server.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-2" class="outline-2">
<h2 id="sec-2"><span class="section-number-2">2</span> How the Alertmanager works</h2>
<div class="outline-text-2" id="text-2">

<figure>
<p><img src="assets/alertmanager-arch.png" class="img-responsive" alt="alertmanager-arch.png">
</p>
</figure>
</div>
</div>

<div id="outline-container-sec-3" class="outline-2">
<h2 id="sec-3"><span class="section-number-2">3</span> Installing Alertmanager</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Available as a standalone Go binary.
</li>
<li><a href="https://github.com/prometheus/alertmanager/releases">Downloadable from Github releases</a>
</li>
</ul>

<div class="highlight"><pre><span></span>  $ cd alertmanager-0.21.0.linux-amd64
  $ ls
  alertmanager*  alertmanager.yml  amtool*  LICENSE  NOTICE
</pre></div>

<ul class="org-ul">
<li><b>amtool</b> is used to help manage the alertmanager and schedule
maintenance windows from the command line.
</li>
</ul>

<div class="highlight"><pre><span></span>  $ alertmanager --version
  alertmanager, version 0.21.0 (branch: HEAD, revision: 4c6c03ebfe21009c546e4d1e9b92c371d67c021d)
  build user:       root@dee35927357f
  build date:       20200617-08:54:02
  go version:       go1.14.4
</pre></div>
</div>
</div>

<div id="outline-container-sec-4" class="outline-2">
<h2 id="sec-4"><span class="section-number-2">4</span> Configuring the Alertmanager</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>alertmanager.yml is used to configure it. Default configuration
file:

<div class="highlight"><pre><span></span>$ bat alertmanager.yml
───────┬──────────────────────────────────────────────
       │ File: alertmanager.yml
───────┼──────────────────────────────────────────────
   1   │ global:
   2   │   resolve_timeout: 5m
   3   │
   4   │ route:
   5   │   group_by: [&#39;alertname&#39;]
   6   │   group_wait: 10s
   7   │   group_interval: 10s
   8   │   repeat_interval: 1h
   9   │   receiver: &#39;web.hook&#39;
  10   │ receivers:
  11   │ - name: &#39;web.hook&#39;
  12   │   webhook_configs:
  13   │   - url: &#39;http://127.0.0.1:5001/&#39;
  14   │ inhibit_rules:
  15   │   - source_match:
  16   │       severity: &#39;critical&#39;
  17   │     target_match:
  18   │       severity: &#39;warning&#39;
  19   │     equal: [&#39;alertname&#39;, &#39;dev&#39;, &#39;instance&#39;]
───────┴──────────────────────────────────────────────
</pre></div>
</li>

<li><a href="https://prometheus.io/docs/alerting/latest/configuration/">Official reference of the above configuration</a>
</li>
<li><b>route</b> block tells alertmanager what to do with specific incoming
alerts.
</li>
<li><b>receiver</b> block specifies alert destination.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-5" class="outline-2">
<h2 id="sec-5"><span class="section-number-2">5</span> Running Alertmanger</h2>
<div class="outline-text-2" id="text-5">
<div class="highlight"><pre><span></span>  $ alertmanager --config.file alertmanager.yml
</pre></div>

<p>
Access web interface on <a href="http://localhost:9093">http://localhost:9093</a>
</p>
</div>

<div id="outline-container-sec-5-1" class="outline-3">
<h3 id="sec-5-1"><span class="section-number-3">5.1</span> Configuring prometheus for Alertmanager</h3>
<div class="outline-text-3" id="text-5-1">
<p>
Edit prometheus.yml:
</p>

<div class="highlight"><pre><span></span>alerting:
  alertmanagers:
  - static_configs:
    - targets:
      - alertmanager:9093
</pre></div>

<p>
Re-run the prometheus server and you can see the configured
alertmanager in <a href="http://localhost:9090/status">http://localhost:9090/status</a>
</p>
</div>
</div>

<div id="outline-container-sec-5-2" class="outline-3">
<h3 id="sec-5-2"><span class="section-number-3">5.2</span> Monitoring Alertmanager</h3>
<div class="outline-text-3" id="text-5-2">
<p>
Even alertmanager exposes metrics, let's configure <code>prometheus.yml</code>
to scrape it:
</p>

<div class="highlight"><pre><span></span>  - job_name: &#39;alertmanager&#39;
    static_configs:
    - targets: [&#39;localhost:9093&#39;]
</pre></div>

<p>
This will scrape a series of time series prefixed with
<b>alertmanager_</b>
</p>
</div>
</div>
</div>

<div id="outline-container-sec-6" class="outline-2">
<h2 id="sec-6"><span class="section-number-2">6</span> Adding alerting rules</h2>
<div class="outline-text-2" id="text-6">
<div class="highlight"><pre><span></span>  $ touch node_alerts.yml
</pre></div>

<p>
Edit prometheus.yml:
</p>

<div class="highlight"><pre><span></span>  rule_files:
   - &quot;rules/node_alerts.yml&quot;
</pre></div>

<div class="highlight"><pre><span></span>$ bat rules/node_alerts.yml
───────┬────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       │ File: rules/node_alerts.yml
───────┼────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
   1   │ groups:
   2   │ - name: node_alerts
   3   │   rules:
   4   │   - alert: HighNodeCpu
   5   │     expr: instance:node_cpu:avg_rate5m &gt; 80
   6   │     for: 60m
   7   │     labels:
   8   │      severity: warning
   9   │     annotations:
  10   │      summary: High Node CPU for 1 hour
  11   │      console: You might want to check the Node Dashboard at http://working-grafana-url.com
</pre></div>

<ul class="org-ul">
<li>Note that the metric <b>instance:node<sub>cpu</sub>:avg<sub>rate5m</sub></b> was already
created in <a href="chapter4.html">Chapter 4</a>
</li>
<li>Group name: <b>node<sub>alerts</sub></b>
</li>
<li>Alert name: <b>HighNodeCpu</b>
</li>
<li>In each alert group, the alert name needs to be unique.
</li>
<li><b>expr</b> clause contains the expression that will trigger the alert.
</li>
<li><b>for</b> clause controls the length of time the test expression must
be true for before the alert is fired.
</li>
<li><b>label</b> clause allows us to specify additional labels to be
attached to the alert.
</li>
<li><b>annotation</b> clause allows us to specify informational labels like
a description, a link to a run book, or instructions on how to
handle the alert.
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-7" class="outline-2">
<h2 id="sec-7"><span class="section-number-2">7</span> Alert States</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li><b>Inactive</b>: The alert is not active
</li>
<li><b>Pending</b>: The alert has met the expression but is still waiting for
the duration specified in the <b>for</b> clause.
</li>
<li><b>Firing</b>: Alert has met the expression and has been in <b>Pending</b>
state for longer than the druation of the <b>for</b> clause.

<p>
You can see the above states in <a href="http://localhost:9090/alerts">Prometheus dashboard</a>
</p>
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-8" class="outline-2">
<h2 id="sec-8"><span class="section-number-2">8</span> Routing</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>Alertmanager needs to route to various destinations.
</li>
<li>Routing acts like a tree. The top, default route is always
configured and matches anything that isn't matched by a child route.

<div class="highlight"><pre><span></span>route:
  group_by: [&#39;alertname&#39;]
  group_wait: 10s
  group_interval: 10s
  repeat_interval: 1h
  receiver: &#39;email&#39;
  routes:
    - match:
        severity: critical
      receiver: pager
    - match_re:
        severity: ^(warning|critical)$
      receiver: support_team
receivers:
- name: &#39;email&#39;
  email_configs:
  - to: &#39;alerts@example.com&#39;
- name: &#39;pager&#39;
  email_configs:
  - to: &#39;alert-pager@example.com&#39;
- name: &#39;support_team&#39;
  email_configs:
  - to: &#39;support@example.com&#39;
</pre></div>
</li>

<li><b>group<sub>by</sub></b> controls how the Alertmanager groups alerts. In the above
example all alerts from a specific instance will be grouped
together.
</li>
<li><b>group<sub>wait</sub></b> is to see if other alerts from that group are received
before firing the alerts.
</li>
<li><b>group<sub>interval</sub></b>: After alerts are fired, if new alerts from the
next evaulation are received for the grouping, Alertmanager will
wait for the peroid mentioned in the <code>group_interval</code> option before
sending the new alerts. This is to prevent alert floods for grouping
of alerts.
</li>
<li><b>repeat<sub>interval</sub></b> is a pause that is applied to each single alert
and is the period to wait to resend the same alert.
</li>
</ul>
</div>

<div id="outline-container-sec-8-1" class="outline-3">
<h3 id="sec-8-1"><span class="section-number-3">8.1</span> Resolution alerts</h3>
<div class="outline-text-3" id="text-8-1">
<ul class="org-ul">
<li>These are alerts generated when the alert condition has been resolved.
</li>
<li><a href="https://prometheus.io/docs/alerting/latest/configuration/#email_config">Configured via send<sub>resolved</sub> in your receiver configuration</a>
</li>
<li>Sending resolution alerts is not recommended.
</li>
</ul>
</div>
</div>
</div>

<div id="outline-container-sec-9" class="outline-2">
<h2 id="sec-9"><span class="section-number-2">9</span> Silences and maintenance</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>Prometheus calls muting of alerts as a "silence"  .
</li>
<li>Useful if you want to take your service down for maintenance and
don't want alarms to be triggered.
</li>
<li>Silences can be set for specific period or you can manually expire
it.
</li>
</ul>

<p>
You can schedule silences using
</p>

<ul class="org-ul">
<li>Alertmanager dashboard: <a href="http://localhost:9093/">http://localhost:9093/</a>
</li>
<li><b>amtool</b> CLI (<a href="https://github.com/prometheus/alertmanager#amtool">Tutorial here</a>)
</li>
</ul>
</div>
</div>

<div id="outline-container-sec-10" class="outline-2">
<h2 id="sec-10"><span class="section-number-2">10</span> References</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li><a href="https://github.com/samber/awesome-prometheus-alerts">Github repo: Awesome prometheus alerts</a>
<ul class="org-ul">
<li><a href="https://awesome-prometheus-alerts.grep.to/">Webpage</a>
</li>
</ul>
</li>
<li><a href="https://github.com/jpweber/prometheus-alert-rules">Github repo: Prometheus alert rules</a>
</li>
</ul>
</div>
</div>
</div></div></div>
<footer id="postamble" class="">
<div><p class="author">Author: Sibi Prabakaran</p>
<p class="date">Created: 2022-01-03 Mon 13:05</p>
<p class="creator"><a href="http://www.gnu.org/software/emacs/">Emacs</a> 27.2 (<a href="http://orgmode.org">Org-mode</a> 9.4.4)</p>
</div>
</footer>
</body>
</html>
